<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geometric Formulas Quiz</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- MathJax for rendering formulas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Nunito:wght@400;700&display=swap');
        
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');

        body {
            font-family: 'Nunito', 'Noto Sans TC', sans-serif;
            background-color: #f0f9ff;
        }
        
        h1, h2, h3, button {
            font-family: 'Fredoka', 'Noto Sans TC', sans-serif;
        }

        /* Custom Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        .btn-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .correct-anim {
            animation: pulse-green 0.5s ease-in-out;
            background-color: #dcfce7 !important;
            border-color: #22c55e !important;
            color: #15803d !important;
        }

        .wrong-anim {
            animation: shake 0.4s ease-in-out;
            background-color: #fee2e2 !important;
            border-color: #ef4444 !important;
            color: #b91c1c !important;
        }

        @keyframes pulse-green {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Scrollbar styling for webkit */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-2 sm:p-4">

    <!-- App Container -->
    <div id="app" class="w-full max-w-2xl bg-white rounded-2xl shadow-xl flex flex-col relative border border-slate-200 max-h-[90vh] overflow-hidden">
        
        <!-- Header -->
        <header class="bg-indigo-600 p-4 text-white flex justify-between items-center shadow-md z-10 shrink-0">
            <div class="flex items-center gap-2">
                <svg class="w-6 h-6 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                <span id="app-title" class="font-bold text-lg tracking-wide truncate">Geometric Formulas Quiz</span>
            </div>
            <div class="flex items-center gap-3">
                <div id="progress-container" class="hidden text-sm font-semibold bg-indigo-700 px-3 py-1 rounded-full whitespace-nowrap">
                    <span id="current-q">1</span> / <span id="total-q">0</span>
                </div>
                <!-- Language Toggle -->
                <button onclick="quizApp.toggleLanguage()" class="text-sm font-bold bg-indigo-500 hover:bg-indigo-400 px-2 py-1 rounded border border-indigo-400 transition">
                    <span id="lang-btn-text">中文</span>
                </button>
            </div>
        </header>

        <!-- Main Content Area (Scrollable) -->
        <main class="flex-grow relative bg-slate-50 flex flex-col items-center p-6 w-full overflow-y-auto">
            
            <!-- Start Screen -->
            <div id="start-screen" class="text-center w-full max-w-md space-y-8 animate-fade-in my-auto">
                <div class="space-y-4">
                    <h1 id="start-title" class="text-4xl font-bold text-slate-800">2D & 3D Formulas</h1>
                    <p id="start-desc" class="text-slate-600 text-lg">Test your knowledge of Area (2D) and Volume (3D) formulas.</p>
                </div>

                <div class="grid grid-cols-3 gap-4 py-6 opacity-60">
                    <div class="bg-white p-3 rounded-lg shadow-sm border border-slate-200 aspect-square flex items-center justify-center">
                        <svg width="40" height="40" viewBox="0 0 100 100" class="stroke-indigo-400 stroke-2 fill-none"><circle cx="50" cy="50" r="30" /></svg>
                    </div>
                    <div class="bg-white p-3 rounded-lg shadow-sm border border-slate-200 aspect-square flex items-center justify-center">
                        <svg width="40" height="40" viewBox="0 0 100 100" class="stroke-indigo-400 stroke-2 fill-none"><path d="M50 15 L85 80 L15 80 Z" /></svg>
                    </div>
                    <div class="bg-white p-3 rounded-lg shadow-sm border border-slate-200 aspect-square flex items-center justify-center">
                        <svg width="40" height="40" viewBox="0 0 100 100" class="stroke-indigo-400 stroke-2 fill-none">
                            <ellipse cx="50" cy="20" rx="30" ry="10" />
                            <path d="M20 20 v60 a30 10 0 0 0 60 0 v-60" />
                        </svg>
                    </div>
                </div>

                <button id="start-btn" onclick="quizApp.startQuiz()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white text-xl font-bold py-4 px-8 rounded-xl shadow-lg transform transition active:scale-95 btn-hover">
                    Start Quiz
                </button>
            </div>

            <!-- Question Screen -->
            <div id="quiz-screen" class="hidden w-full max-w-lg flex flex-col items-center space-y-6 animate-fade-in pb-4">
                
                <div class="w-full h-56 bg-white rounded-xl shadow-inner border border-slate-200 flex items-center justify-center p-4 relative overflow-hidden shrink-0">
                    <div class="absolute inset-0 bg-slate-50 opacity-50 bg-[radial-gradient(#e5e7eb_1px,transparent_1px)] [background-size:16px_16px]"></div>
                    <div id="svg-container" class="relative z-10 w-full h-full flex items-center justify-center"></div>
                </div>

                <div class="text-center space-y-2 shrink-0">
                    <h2 class="text-xl md:text-2xl font-bold text-slate-800">
                        <span id="q-type" class="text-indigo-500 text-base block uppercase tracking-wider font-semibold mb-1">Type</span>
                        <span id="shape-name">Shape Name</span>
                    </h2>
                    <p id="variable-def" class="text-sm text-slate-500 bg-white px-3 py-1 rounded-full shadow-sm border border-slate-100 inline-block">
                        Variables
                    </p>
                </div>

                <div id="options-grid" class="grid grid-cols-1 md:grid-cols-2 gap-3 w-full shrink-0">
                    <!-- Buttons injected via JS -->
                </div>

                <div id="feedback-area" class="hidden w-full p-4 rounded-lg text-center font-bold text-lg animate-fade-in flex flex-col gap-2 shrink-0">
                    <span id="feedback-text"></span>
                </div>
                
                <div class="flex gap-3 w-full mt-2 shrink-0 pb-4">
                    <button id="prev-btn" onclick="quizApp.prevQuestion()" class="hidden flex-1 bg-slate-200 text-slate-700 py-3 rounded-lg font-bold hover:bg-slate-300 transition shadow-sm">
                        Previous
                    </button>
                    <button id="next-btn" onclick="quizApp.nextQuestion()" class="hidden flex-1 bg-slate-800 text-white py-3 rounded-lg font-bold hover:bg-slate-900 transition shadow-lg">
                        Next Question
                    </button>
                </div>

            </div>

            <!-- Result Screen -->
            <div id="result-screen" class="hidden text-center w-full max-w-md space-y-8 animate-fade-in my-auto pb-6">
                <div class="space-y-2">
                    <h2 id="res-title" class="text-3xl font-bold text-slate-800">Quiz Complete!</h2>
                    <p id="res-msg" class="text-slate-600">Great effort! Here is your result.</p>
                </div>

                <div class="relative w-48 h-48 mx-auto flex items-center justify-center">
                    <svg class="w-full h-full transform -rotate-90">
                        <circle cx="96" cy="96" r="88" fill="none" stroke="#e2e8f0" stroke-width="12" />
                        <circle id="score-circle" cx="96" cy="96" r="88" fill="none" stroke="#4f46e5" stroke-width="12" stroke-dasharray="552" stroke-dashoffset="0" stroke-linecap="round" class="transition-all duration-1000 ease-out"/>
                    </svg>
                    <div class="absolute inset-0 flex flex-col items-center justify-center">
                        <span id="final-score" class="text-5xl font-bold text-slate-800">0</span>
                        <span id="res-points" class="text-sm text-slate-500 font-semibold uppercase tracking-wider">Points</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <button id="res-retry" onclick="quizApp.restartQuiz()" class="bg-indigo-600 hover:bg-indigo-700 text-white py-3 px-6 rounded-xl font-bold transition shadow-lg btn-hover w-full">
                        Try Again
                    </button>
                    <button id="res-print" onclick="window.print()" class="bg-white text-slate-700 border border-slate-300 hover:bg-slate-50 py-3 px-6 rounded-xl font-bold transition shadow-sm btn-hover w-full">
                        Print Results
                    </button>
                </div>
            </div>

        </main>
    </div>

    <!-- Script -->
    <script>
        // --- Translations ---
        const translations = {
            en: {
                title: "Geometric Formulas Quiz",
                startTitle: "2D & 3D Formulas",
                startDesc: "Test your knowledge of Area (2D) and Volume (3D) formulas.",
                startBtn: "Start Quiz",
                typeTitle: "Type",
                type2D: "2D Figure",
                type3D: "3D Figure",
                varsTitle: "Variables",
                btnPrev: "Previous",
                btnNext: "Next Question",
                resTitle: "Quiz Complete!",
                resMsg: "Great effort! Here is your result.",
                resPoints: "Points",
                resRetry: "Try Again",
                resPrint: "Print Results",
                feedbackCorrect: "Correct!",
                feedbackWrong: "Incorrect. The correct answer is highlighted.",
                langBtn: "中文", // Button shows target language
            },
            zh: {
                title: "幾何公式測驗",
                startTitle: "平面與立體公式",
                startDesc: "測試您對面積 (平面) 和體積 (立體) 公式的認識。",
                startBtn: "開始測驗",
                typeTitle: "類別",
                type2D: "平面圖形",
                type3D: "立體圖形",
                varsTitle: "變量",
                btnPrev: "上一題",
                btnNext: "下一題",
                resTitle: "測驗完成！",
                resMsg: "做得好！這是您的成績。",
                resPoints: "得分",
                resRetry: "再試一次",
                resPrint: "列印結果",
                feedbackCorrect: "正確！",
                feedbackWrong: "不正確。正確答案已標示。",
                langBtn: "English",
            }
        };

        // Data Structure for Shapes with bilingual support
        const quizData = [
            {
                name: { en: "Triangle Area", zh: "三角形面積" },
                type: "2D",
                draw: (w, h, lang) => `
                    <svg width="${w}" height="${h}" viewBox="0 0 200 150">
                        <path d="M30 130 L170 130 L100 20 Z" fill="#e0e7ff" stroke="#4338ca" stroke-width="3" stroke-linejoin="round"/>
                        <line x1="100" y1="20" x2="100" y2="130" stroke="#64748b" stroke-width="2" stroke-dasharray="5,5" />
                        <polyline points="100,120 110,120 110,130" fill="none" stroke="#64748b" stroke-width="2" />
                        <text x="100" y="148" text-anchor="middle" font-size="16" fill="#1e293b" font-weight="bold">b</text>
                        <text x="90" y="80" text-anchor="end" font-size="16" fill="#1e293b" font-weight="bold">h</text>
                    </svg>
                `,
                variables: { en: "b = base, h = height", zh: "b = 底, h = 高" },
                correct: "\\( A = \\frac{1}{2}bh \\)",
                rawCorrect: "A = 1/2 * b * h",
                options: ["\\( A = \\frac{1}{2}bh \\)", "\\( A = bh \\)", "\\( A = \\frac{1}{2}(b+h) \\)", "\\( A = b^2 + h^2 \\)"]
            },
            {
                name: { en: "Square Area", zh: "正方形面積" },
                type: "2D",
                draw: (w, h, lang) => `
                    <svg width="${w}" height="${h}" viewBox="0 0 200 150">
                        <rect x="50" y="25" width="100" height="100" fill="#e0e7ff" stroke="#4338ca" stroke-width="3" />
                        <line x1="50" y1="75" x2="40" y2="75" stroke="#4338ca" stroke-width="2" />
                        <line x1="150" y1="75" x2="160" y2="75" stroke="#4338ca" stroke-width="2" />
                        <line x1="100" y1="25" x2="100" y2="15" stroke="#4338ca" stroke-width="2" />
                        <line x1="100" y1="125" x2="100" y2="135" stroke="#4338ca" stroke-width="2" />
                        <text x="100" y="145" text-anchor="middle" font-size="16" fill="#1e293b" font-weight="bold">s</text>
                        <text x="35" y="75" text-anchor="end" font-size="16" fill="#1e293b" font-weight="bold">s</text>
                    </svg>
                `,
                variables: { en: "s = side length", zh: "s = 邊長" },
                correct: "\\( A = s^2 \\)",
                rawCorrect: "A = s^2",
                options: ["\\( A = 4s \\)", "\\( A = s^2 \\)", "\\( A = 2s \\)", "\\( A = s + s \\)"]
            },
            {
                name: { en: "Circle Area", zh: "圓形面積" },
                type: "2D",
                draw: (w, h, lang) => `
                    <svg width="${w}" height="${h}" viewBox="0 0 200 150">
                        <circle cx="100" cy="75" r="50" fill="#e0e7ff" stroke="#4338ca" stroke-width="3" />
                        <line x1="100" y1="75" x2="150" y2="75" stroke="#64748b" stroke-width="2" />
                        <circle cx="100" cy="75" r="3" fill="#64748b" />
                        <text x="125" y="65" text-anchor="middle" font-size="16" fill="#1e293b" font-weight="bold">r</text>
                    </svg>
                `,
                variables: { en: "r = radius", zh: "r = 半徑" },
                correct: "\\( A = \\pi r^2 \\)",
                rawCorrect: "A = pi * r^2",
                options: ["\\( A = 2\\pi r \\)", "\\( A = \\pi r^2 \\)", "\\( A = \\pi d \\)", "\\( A = \\frac{1}{2}\\pi r^2 \\)"]
            },
            {
                name: { en: "Trapezoid Area", zh: "梯形面積" },
                type: "2D",
                draw: (w, h, lang) => `
                    <svg width="${w}" height="${h}" viewBox="0 0 200 150">
                        <path d="M40 120 L160 120 L140 40 L60 40 Z" fill="#e0e7ff" stroke="#4338ca" stroke-width="3" stroke-linejoin="round"/>
                        <line x1="60" y1="40" x2="60" y2="120" stroke="#64748b" stroke-width="2" stroke-dasharray="5,5" />
                        <polyline points="60,110 70,110 70,120" fill="none" stroke="#64748b" stroke-width="2" />
                        <text x="100" y="140" text-anchor="middle" font-size="16" fill="#1e293b" font-weight="bold">b</text>
                        <text x="100" y="30" text-anchor="middle" font-size="16" fill="#1e293b" font-weight="bold">a</text>
                        <text x="50" y="80" text-anchor="end" font-size="16" fill="#1e293b" font-weight="bold">h</text>
                    </svg>
                `,
                variables: { en: "a, b = parallel sides, h = height", zh: "a, b = 平行邊 (上底/下底), h = 高" },
                correct: "\\( A = \\frac{1}{2}(a+b)h \\)",
                rawCorrect: "A = 1/2 * (a + b) * h",
                options: ["\\( A = abh \\)", "\\( A = \\frac{a+b}{2} \\)", "\\( A = \\frac{1}{2}(a+b)h \\)", "\\( A = (a+b)h \\)"]
            },
            {
                name: { en: "Cylinder Volume", zh: "圓柱體體積" },
                type: "3D",
                draw: (w, h, lang) => `
                    <svg width="${w}" height="${h}" viewBox="0 0 200 150">
                        <path d="M60 110 a40 15 0 0 0 80 0" fill="#e0e7ff" stroke="#4338ca" stroke-width="3"/>
                        <path d="M60 110 a40 15 0 0 1 80 0" fill="#e0e7ff" stroke="#4338ca" stroke-width="2" stroke-dasharray="4,4" opacity="0.5"/>
                        <path d="M60 40 v70 M140 40 v70" stroke="#4338ca" stroke-width="3" fill="none"/>
                        <rect x="60" y="40" width="80" height="70" fill="#e0e7ff" stroke="none" opacity="0.3"/>
                        <ellipse cx="100" cy="40" rx="40" ry="15" fill="#e0e7ff" stroke="#4338ca" stroke-width="3" />
                        <line x1="100" y1="40" x2="140" y2="40" stroke="#64748b" stroke-width="2"/>
                        <text x="120" y="35" text-anchor="middle" font-size="16" fill="#1e293b" font-weight="bold">r</text>
                        <line x1="150" y1="40" x2="150" y2="110" stroke="#64748b" stroke-width="2"/>
                        <text x="160" y="80" text-anchor="start" font-size="16" fill="#1e293b" font-weight="bold">h</text>
                    </svg>
                `,
                variables: { en: "r = radius, h = height", zh: "r = 半徑, h = 高" },
                correct: "\\( V = \\pi r^2 h \\)",
                rawCorrect: "V = pi * r^2 * h",
                options: ["\\( V = \\pi r^2 h \\)", "\\( V = 2\\pi r h \\)", "\\( V = \\frac{1}{3}\\pi r^2 h \\)", "\\( V = lwh \\)"]
            },
            {
                name: { en: "Sphere Volume", zh: "球體體積" },
                type: "3D",
                draw: (w, h, lang) => `
                    <svg width="${w}" height="${h}" viewBox="0 0 200 150">
                        <circle cx="100" cy="75" r="50" fill="#e0e7ff" stroke="#4338ca" stroke-width="3" />
                        <ellipse cx="100" cy="75" rx="50" ry="15" fill="none" stroke="#4338ca" stroke-width="2" stroke-dasharray="4,4" opacity="0.6"/>
                        <line x1="100" y1="75" x2="150" y2="75" stroke="#64748b" stroke-width="2" />
                        <circle cx="100" cy="75" r="3" fill="#64748b" />
                        <text x="125" y="65" text-anchor="middle" font-size="16" fill="#1e293b" font-weight="bold">r</text>
                    </svg>
                `,
                variables: { en: "r = radius", zh: "r = 半徑" },
                correct: "\\( V = \\frac{4}{3}\\pi r^3 \\)",
                rawCorrect: "V = 4/3 * pi * r^3",
                options: ["\\( V = 4\\pi r^2 \\)", "\\( V = \\pi r^3 \\)", "\\( V = \\frac{4}{3}\\pi r^3 \\)", "\\( V = \\frac{2}{3}\\pi r^2 h \\)"]
            },
            {
                name: { en: "Cone Volume", zh: "圓錐體體積" },
                type: "3D",
                draw: (w, h, lang) => `
                    <svg width="${w}" height="${h}" viewBox="0 0 200 150">
                        <path d="M60 110 L100 20 L140 110" fill="#e0e7ff" stroke="#4338ca" stroke-width="3" stroke-linejoin="round"/>
                        <ellipse cx="100" cy="110" rx="40" ry="12" fill="#e0e7ff" stroke="#4338ca" stroke-width="3" />
                        <line x1="100" y1="20" x2="100" y2="110" stroke="#64748b" stroke-width="2" stroke-dasharray="5,5" />
                        <line x1="100" y1="110" x2="140" y2="110" stroke="#64748b" stroke-width="2" />
                        <text x="120" y="105" text-anchor="middle" font-size="16" fill="#1e293b" font-weight="bold">r</text>
                        <text x="90" y="70" text-anchor="end" font-size="16" fill="#1e293b" font-weight="bold">h</text>
                    </svg>
                `,
                variables: { en: "r = radius, h = height", zh: "r = 半徑, h = 高" },
                correct: "\\( V = \\frac{1}{3}\\pi r^2 h \\)",
                rawCorrect: "V = 1/3 * pi * r^2 * h",
                options: ["\\( V = \\pi r^2 h \\)", "\\( V = \\frac{4}{3}\\pi r^3 \\)", "\\( V = \\frac{1}{2}bh \\)", "\\( V = \\frac{1}{3}\\pi r^2 h \\)"]
            },
            {
                name: { en: "Rectangular Prism", zh: "長方體體積" },
                type: "3D",
                draw: (w, h, lang) => `
                    <svg width="${w}" height="${h}" viewBox="0 0 200 150">
                        <rect x="40" y="50" width="80" height="60" fill="#e0e7ff" stroke="#4338ca" stroke-width="3" />
                        <polyline points="40,50 70,30 150,30 150,90 120,110" fill="none" stroke="#4338ca" stroke-width="3" stroke-linejoin="round"/>
                        <line x1="150" y1="30" x2="120" y2="50" stroke="#4338ca" stroke-width="3" />
                        <polyline points="40,110 70,90 150,90" fill="none" stroke="#4338ca" stroke-width="2" stroke-dasharray="4,4" opacity="0.4"/>
                        <line x1="70" y1="30" x2="70" y2="90" stroke="#4338ca" stroke-width="2" stroke-dasharray="4,4" opacity="0.4"/>
                        <text x="80" y="125" text-anchor="middle" font-size="16" fill="#1e293b" font-weight="bold">l</text>
                        <text x="140" y="115" text-anchor="middle" font-size="16" fill="#1e293b" font-weight="bold">w</text>
                        <text x="30" y="85" text-anchor="middle" font-size="16" fill="#1e293b" font-weight="bold">h</text>
                    </svg>
                `,
                variables: { en: "l = length, w = width, h = height", zh: "l = 長, w = 寬, h = 高" },
                correct: "\\( V = lwh \\)",
                rawCorrect: "V = l * w * h",
                options: ["\\( V = l + w + h \\)", "\\( V = lwh \\)", "\\( V = 2(lw + lh + wh) \\)", "\\( V = \\frac{1}{2}lwh \\)"]
            },
            {
                name: { en: "Square Pyramid", zh: "正方錐體積" },
                type: "3D",
                draw: (w, h, lang) => {
                    const label = lang === 'zh' ? '底面積 (B)' : 'Base Area (B)';
                    return `
                    <svg width="${w}" height="${h}" viewBox="0 0 200 150">
                        <path d="M100 20 L40 120 L160 120 Z" fill="#e0e7ff" stroke="#4338ca" stroke-width="3" stroke-linejoin="round"/>
                        <path d="M160 120 L130 100 L100 20" fill="none" stroke="#4338ca" stroke-width="3" stroke-linejoin="round"/>
                        <path d="M40 120 L130 100" fill="none" stroke="#4338ca" stroke-width="2" stroke-dasharray="4,4" opacity="0.5"/>
                        <line x1="100" y1="20" x2="100" y2="110" stroke="#64748b" stroke-width="2" stroke-dasharray="5,5"/>
                        <text x="105" y="70" text-anchor="start" font-size="16" fill="#1e293b" font-weight="bold">h</text>
                        <text x="100" y="135" text-anchor="middle" font-size="14" fill="#1e293b" font-weight="bold">${label}</text>
                    </svg>
                `},
                variables: { en: "B = Base Area, h = height", zh: "B = 底面積, h = 高" },
                correct: "\\( V = \\frac{1}{3}Bh \\)",
                rawCorrect: "V = 1/3 * B * h",
                options: ["\\( V = \\frac{1}{3}Bh \\)", "\\( V = Bh \\)", "\\( V = \\frac{1}{2}Bh \\)", "\\( V = lwh \\)"]
            }
        ];

        class QuizApp {
            constructor() {
                this.state = {
                    currentQuestionIndex: 0,
                    score: 0,
                    questions: [],
                    isAnswering: false,
                    lang: 'en' // Default language
                };

                this.ui = {
                    app: document.getElementById('app'),
                    appTitle: document.getElementById('app-title'),
                    langBtn: document.getElementById('lang-btn-text'),
                    startScreen: document.getElementById('start-screen'),
                    startTitle: document.getElementById('start-title'),
                    startDesc: document.getElementById('start-desc'),
                    startBtn: document.getElementById('start-btn'),
                    
                    quizScreen: document.getElementById('quiz-screen'),
                    svgContainer: document.getElementById('svg-container'),
                    shapeName: document.getElementById('shape-name'),
                    qType: document.getElementById('q-type'),
                    variableDef: document.getElementById('variable-def'),
                    optionsGrid: document.getElementById('options-grid'),
                    currentQ: document.getElementById('current-q'),
                    totalQ: document.getElementById('total-q'),
                    progressContainer: document.getElementById('progress-container'),
                    feedbackArea: document.getElementById('feedback-area'),
                    feedbackText: document.getElementById('feedback-text'),
                    prevBtn: document.getElementById('prev-btn'),
                    nextBtn: document.getElementById('next-btn'),
                    
                    resultScreen: document.getElementById('result-screen'),
                    resTitle: document.getElementById('res-title'),
                    resMsg: document.getElementById('res-msg'),
                    resPoints: document.getElementById('res-points'),
                    resRetry: document.getElementById('res-retry'),
                    resPrint: document.getElementById('res-print'),
                    finalScore: document.getElementById('final-score'),
                    scoreCircle: document.getElementById('score-circle'),
                };
            }

            shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            toggleLanguage() {
                this.state.lang = this.state.lang === 'en' ? 'zh' : 'en';
                this.updateUIText();
                
                // If quiz is running, re-render current question
                if (!this.ui.quizScreen.classList.contains('hidden')) {
                    this.loadQuestion(); 
                }
            }

            updateUIText() {
                const t = translations[this.state.lang];
                
                this.ui.appTitle.textContent = t.title;
                this.ui.langBtn.textContent = t.langBtn;
                this.ui.startTitle.textContent = t.startTitle;
                this.ui.startDesc.textContent = t.startDesc;
                this.ui.startBtn.textContent = t.startBtn;
                
                this.ui.prevBtn.textContent = t.btnPrev;
                this.ui.nextBtn.textContent = t.btnNext;
                
                this.ui.resTitle.textContent = t.resTitle;
                this.ui.resMsg.textContent = t.resMsg;
                this.ui.resPoints.textContent = t.resPoints;
                this.ui.resRetry.textContent = t.resRetry;
                this.ui.resPrint.textContent = t.resPrint;
            }

            startQuiz() {
                const shuffledQuestions = this.shuffleArray([...quizData]).map(q => ({
                    ...q,
                    shuffledOptions: this.shuffleArray([...q.options]),
                    userAnswer: null,
                    isCorrect: false
                }));

                this.state.questions = shuffledQuestions;
                this.state.currentQuestionIndex = 0;
                this.state.score = 0;
                
                this.ui.startScreen.classList.add('hidden');
                this.ui.resultScreen.classList.add('hidden');
                this.ui.quizScreen.classList.remove('hidden');
                this.ui.progressContainer.classList.remove('hidden');
                this.ui.totalQ.textContent = this.state.questions.length;

                this.updateUIText();
                this.loadQuestion();
            }

            loadQuestion() {
                const q = this.state.questions[this.state.currentQuestionIndex];
                const t = translations[this.state.lang];
                this.state.isAnswering = (q.userAnswer === null);
                
                this.ui.currentQ.textContent = this.state.currentQuestionIndex + 1;
                
                // Draw SVG with Language
                this.ui.svgContainer.innerHTML = q.draw("100%", "100%", this.state.lang);
                
                // Set text based on language
                this.ui.shapeName.textContent = q.name[this.state.lang];
                this.ui.qType.textContent = q.type === "2D" ? t.type2D : t.type3D;
                this.ui.variableDef.textContent = q.variables[this.state.lang];

                this.ui.feedbackArea.classList.add('hidden');
                this.ui.feedbackArea.classList.remove('correct-anim', 'wrong-anim');
                
                // Nav Buttons
                if (this.state.currentQuestionIndex > 0) {
                    this.ui.prevBtn.classList.remove('hidden');
                } else {
                    this.ui.prevBtn.classList.add('hidden');
                }

                if (q.userAnswer !== null) {
                    this.ui.nextBtn.classList.remove('hidden');
                } else {
                    this.ui.nextBtn.classList.add('hidden');
                }

                this.ui.optionsGrid.innerHTML = '';
                
                q.shuffledOptions.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = "w-full bg-white border-2 border-slate-200 text-slate-700 p-4 rounded-xl text-lg font-medium hover:border-indigo-400 hover:bg-indigo-50 transition duration-200 flex items-center justify-center min-h-[80px]";
                    btn.dataset.originalValue = opt; 
                    btn.innerHTML = opt; 
                    
                    if (q.userAnswer !== null) {
                        btn.disabled = true;
                        btn.classList.add('opacity-70', 'cursor-not-allowed');

                        if (opt === q.correct) {
                            btn.classList.remove('border-slate-200', 'bg-white', 'opacity-70');
                            btn.classList.add('bg-green-100', 'border-green-500', 'text-green-800', 'opacity-100');
                        }
                        if (opt === q.userAnswer && !q.isCorrect) {
                            btn.classList.remove('border-slate-200', 'bg-white');
                            btn.classList.add('bg-red-100', 'border-red-500', 'text-red-800');
                        }
                    } else {
                        btn.onclick = () => this.handleAnswer(btn, opt, q.correct);
                    }

                    this.ui.optionsGrid.appendChild(btn);
                });

                if (q.userAnswer !== null) {
                    if (q.isCorrect) {
                        this.showFeedback(true, t.feedbackCorrect);
                    } else {
                        this.showFeedback(false, t.feedbackWrong);
                    }
                }

                if (window.MathJax) {
                    MathJax.typesetPromise();
                }
            }

            handleAnswer(selectedBtn, selectedValue, correctValue) {
                if (!this.state.isAnswering) return;
                this.state.isAnswering = false;

                const q = this.state.questions[this.state.currentQuestionIndex];
                const t = translations[this.state.lang];
                const isCorrect = selectedValue === correctValue;

                q.userAnswer = selectedValue;
                q.isCorrect = isCorrect;

                const allBtns = this.ui.optionsGrid.querySelectorAll('button');
                allBtns.forEach(btn => {
                    btn.disabled = true;
                    btn.classList.add('opacity-70', 'cursor-not-allowed');
                    
                    if (btn.dataset.originalValue === correctValue) {
                        btn.classList.remove('border-slate-200', 'bg-white', 'opacity-70'); 
                        btn.classList.add('bg-green-100', 'border-green-500', 'text-green-800', 'opacity-100');
                    }
                });

                if (isCorrect) {
                    selectedBtn.classList.add('correct-anim'); 
                    this.showFeedback(true, t.feedbackCorrect);
                } else {
                    selectedBtn.classList.remove('border-slate-200', 'bg-white');
                    selectedBtn.classList.add('wrong-anim', 'bg-red-100', 'border-red-500', 'text-red-800');
                    this.showFeedback(false, t.feedbackWrong);
                }

                this.ui.nextBtn.classList.remove('hidden');
            }

            showFeedback(isCorrect, text) {
                this.ui.feedbackText.textContent = text;
                this.ui.feedbackArea.classList.remove('hidden');
                this.ui.feedbackArea.classList.add(isCorrect ? 'text-green-600' : 'text-red-600', 'bg-slate-100');
                
                if (isCorrect) {
                    this.ui.feedbackArea.classList.remove('text-red-600');
                    this.ui.feedbackArea.classList.add('text-green-600');
                } else {
                    this.ui.feedbackArea.classList.remove('text-green-600');
                    this.ui.feedbackArea.classList.add('text-red-600');
                }
            }

            prevQuestion() {
                if (this.state.currentQuestionIndex > 0) {
                    this.state.currentQuestionIndex--;
                    this.loadQuestion();
                }
            }

            nextQuestion() {
                this.state.currentQuestionIndex++;
                if (this.state.currentQuestionIndex < this.state.questions.length) {
                    this.loadQuestion();
                } else {
                    this.showResults();
                }
            }

            showResults() {
                this.ui.quizScreen.classList.add('hidden');
                this.ui.progressContainer.classList.add('hidden');
                this.ui.resultScreen.classList.remove('hidden');

                const total = this.state.questions.length;
                const score = this.state.questions.filter(q => q.isCorrect).length;
                const percentage = score / total;
                const circumference = 2 * Math.PI * 88;
                const offset = circumference - (percentage * circumference);

                this.ui.finalScore.textContent = `${score}/${total}`;
                
                setTimeout(() => {
                    this.ui.scoreCircle.style.strokeDashoffset = offset;
                    if (percentage >= 0.8) this.ui.scoreCircle.style.stroke = "#22c55e";
                    else if (percentage >= 0.5) this.ui.scoreCircle.style.stroke = "#eab308";
                    else this.ui.scoreCircle.style.stroke = "#ef4444";
                }, 100);
            }

            restartQuiz() {
                this.startQuiz();
            }
        }

        const quizApp = new QuizApp();

    </script>
</body>
</html>